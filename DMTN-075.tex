\documentclass[DM,authoryear,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html

% Package imports go here.
\usepackage{bm}
\usepackage{color}

% Local commands go here.
\newcommand{\todo}[1]{{\color{red}[#1]}}
\newcommand{\ft}[3]{\mathcal{F}_{#1}\!\left\{#3\right\}\!\left[#2\right]}

% To add a short-form title:
% \title[Short title]{Title}
\title{Cell-Based Coaddition}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Jim Bosch, \\
Arun Kannawadi
}

\setDocRef{DMTN-075}

\date{\today}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
Design sketch and mathematics for a new approach to building coadds and constraining their inputs.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYY-MM-DD}{Unreleased.}{Jim Bosch}
}

\begin{document}

% Create the title page.
% Table of contents is added automatically with the "toc" class option.
\maketitle

\section{Likelihood Coadds}

All quantities are defined within a single cell, which is a rectangle with integer-pixel boundaries in the coadd coordinate systen.
Input-image quantities in cells enclose a larger area: they include any pixel that could contribute to that cell on the coadd.
This means that some input-image pixels contribute to multiple cells.
We assume that cells are sufficiently small that all PSFs, coordinate transforms, and backgrounds can be considered constant over any \emph{two} adjacent cells.

The vast majority of astronomical images have very simple noise properties, at least to good approximation.
Even adjacent pixels are typically very close to uncorrelated, and the only significant spatial variation in the variance is due to photon noise from bright objects.
That spatial variation is explicitly ignored in many astronomical algorithms because including it either produces a negligible improvement in signal-to-noise ratio (because noise from the background dominates), or it increases exposure to systematic errors in regimes where the systematic errors dominate \citep[e.g. PSF photometry of bright stars;][]{2018PASJ...70S...5B}.
Allowing small-scale spatially-varying noise to affect the relative weights of images in a coadd is particularly dangerous, as it can make the effective PSFs on those coadds a function of magnitude, in essence making the coadd's respond to flux nonlinear.

This means that at the very least we should require all input image covariances to be stationary.
We will go one step further, and require the input noise to be a per-cell constant variance \emph{for the purposes of combining images}.
After the linear combination of images has been optimized, we will then propagate the original, fully-general noise covariance matrix to determine the final coadd noise covariance.
This will make our image combination slightly lossy, but only in the rare case where some input images have significantly higher correlations between pixels than others.

Definitions:
\begin{itemize}
\item $\bm{\mu}$, $\bm{\nu}$: vector positions in coadd coordinates (each of $\bm{\mu}$ and $\bm{\nu}$ is a tuple of two coordinates).
\item $\lambda$: an \emph{jndex} over wavelength bins
\item $\bm{A}_j$: affine mapping from input image $j$ coordinates $\bm{x}_j$to coadd coordinates.
\item $\bm{x}_{j}$, $\bm{y}_j$: positions in the coordinate system of input image $j$ (each of $\bm{x}$ and $\bm{y}$ is a tuple of two coordinates).
\item $z_{j}[\bm{x}_j]$: the value of the pixel at $\bm{x}_j$ in input image $j$, after background subtraction.
\item $\phi_{j,\lambda}(\bm{\mu}-\bm{\nu})$: PSF that maps true-sky flux at $\bm{\nu}$ to observed flux in input image $j$ at $\bm{\mu}$, integrated over wavelength bin $\lambda$.  Note that this is defined in coadd coordinates, not input image coordinates, even though it includes the pixel response function of image $j$; this convention will simplify the notation of later steps.  Constrained such that
$\int \phi_{j,\lambda}(\bm{\mu}) d^2\bm{\mu} = 1$ for all $\lambda$.
\item $\tau_{j,\lambda}$: Photometric transmission that maps true-sky flux to observed flux in input image $j$, integrated over wavelength bin $\lambda$
\item $V_{j}$: noise variance on input image $j$, assumed constant over the cell.
\item $N$: the number of input images.
\item $W$: the number of wavelength bins.
\item $\bm{E}_j$: the set of all pixel indices in input image $j$ that contribute to the current cell.  $|E_j|$ is used to denote the total number of pixels from that image that contribute to the cell.  Bad pixels can simply be omitted from this set with no loss of generality.
\item $\bm{F}$: the set of all coadd pixel indices in the cell.  $|F|$ is used to denote the total number of pixels in the cell.
\item $\alpha_{\lambda}(\bm{\mu})$: true above-the-atmosphere scene in coadd coordinates, integrated over wavelength bin $\lambda$, not including backgrounds.
\end{itemize}

The approach described here is a generalization of the method described by \citet{2015arXiv151206879Z}, and yields identical results when all input images are well-sampled, there are no missing pixels, and image PSFs are achromatic.  In that limit the input images can be perfectly resampled to a common grid in advance, which is the point at which their algorithm begins.

Instead, we start from the joint log-likelihood of the true scene given all input images in their original coordinate systems, allowing us to handle undersampled data.
That log-likelihood is:
\begin{align}
L \equiv &
    \frac{1}{2} \sum_{j=0}^{j<N}
        \frac{1}{V_j}
        \sum_{\bm{x}_j \in \bm{E}_j}
        \left(
            z_j[\bm{x}_j]
            - \sum_{\lambda=0}^{\lambda < W}
                \tau_{j,\lambda}
                \int\!
                \phi_{j,\lambda}\!\left(
                    \bm{A}(\bm{x}_j) - \bm{\nu}
                \right)
                \; \alpha_{\lambda}(\bm{\nu})
                \; d^2\bm{\nu}
        \right)^2
\end{align}

While the true sky contains power at arbitrarily small spatial scales, the PSFs do not; we can always choose the coadd coordinate system such that all
input PSFs are well-sampled on that grid.
We can thus exactly represent the continuous PSF as a sinc interpolation of
discrete samples from it:
\begin{align}
    \phi_{j,\lambda}\!\left(\bm{A_j}(\bm{x}_j)-\bm{\nu}\right) =
    \sum_{\bm{\mu} \in \bm{F}}
        \mathrm{sinc}\big(\pi(\bm{\nu}-\bm{\mu})\big)
        \;\phi_{j,\lambda}\!\left(
            \bm{A}_j(\bm{x}_j) - \bm{\mu}
        \right)
\end{align}
We can then insert this into the convolution integral,
\begin{align}
    \int\!
        \, \phi_{j,\lambda}\!\left(\bm{A}_j(\bm{x}_j)-\bm{\mu}\right)
        \, \alpha_{\lambda}(\bm{\mu})
        \, d^2\bm{\mu}
    = &
    \sum_{\bm{\mu} \in \bm{F}}
        \;\phi_{j,\lambda}\!\left(
            \bm{A}_j(\bm{x}_j) - \bm{\mu}
        \right)
        \!\int\!
        \mathrm{sinc}\big(\pi(\bm{\nu}-\bm{\mu})\big)
        \; \alpha_{\lambda}(\bm{\nu})
        \; d^2\bm{\nu} \\
    = &
    \sum_{\bm{\mu} \in \bm{F}}
        \;\phi_{j,\lambda}\!\left(
            \bm{A}(\bm{x}_j) - \bm{\mu}
        \right)
        \, f_{\lambda}(\bm{\mu})
\end{align}
with the sinc-convolved true scene $f_{\lambda}$ defined as
\begin{align}
    f_{\lambda}(\bm{\mu}) \equiv \int\!
        \mathrm{sinc}\big(\pi(\bm{\nu}-\bm{\mu})\big)
        \; \alpha_{\lambda}(\bm{\nu})
        \; d^2\bm{\nu}
\end{align}
Thus, $f_{\lambda}$ is essentially a band-limited version of $\alpha_{\lambda}$, restricted to just the spatial frequencies we can constrain from the input data (via our requirement that the coadd coordinate grid fully sample all input PSFs).
We therefore consider any sufficient statistic for $f_{\lambda}$ to also be a sufficient statistic for $\alpha_{\lambda}$.

We can now substitute this into the joint likelihood:
\begin{align}
L = &
    \frac{1}{2} \sum_{j=0}^{j<N}
        \frac{1}{V_j}
        \sum_{\bm{x}_j \in \bm{E}_j}
        \left(
            z_j[\bm{x}_j]
            - \sum_{\lambda=0}^{\lambda < W}
                \tau_{j,\lambda}
                \sum_{\bm{\mu} \in \bm{F}}
                        \;\phi_{j,\lambda}\!\left(
                            \bm{A}_j(\bm{x}_j) - \bm{\mu}
                        \right)
                        \, f_{\lambda}(\bm{\mu})
        \right)^2
\end{align}
expand the terms:
\begin{align}
L =&
        \sum_{j=0}^{j<N}
        \frac{1}{2V_j}
        \sum_{\bm{x}_j \in \bm{E}_j}
        \left(z_j[\bm{x}_j]\right)^2
\nonumber\\
&\;-
    \sum_{j=0}^{j<N}
        \frac{1}{V_j}
        \sum_{\bm{x}_j \in \bm{E}_j}
        \; z_j[\bm{x}_j]
        \sum_{\lambda=0}^{\lambda < W}
            \tau_{j,\lambda}
            \sum_{\bm{\mu} \in \bm{F}}
                    \;\phi_{j,\lambda}\!\left(
                        \bm{A}_j(\bm{x}_j) - \bm{\mu}
                    \right)
                    \, f_{\lambda}(\bm{\mu})
\nonumber\\
&\;+
    \sum_{j=0}^{j<N}
        \frac{1}{2V_j}
        \sum_{\bm{x}_j \in \bm{E}_j}
        \left(
            \sum_{\lambda=0}^{\lambda < W}
                \tau_{j,\lambda}
                \sum_{\bm{\mu} \in \bm{F}}
                        \;\phi_{j,\lambda}\!\left(
                            \bm{A}_j(\bm{x}_j) - \bm{\mu}
                        \right)
                        \, f_{\lambda}(\bm{\mu})
        \right)^2
\end{align}
and reorder the sums (consolidating some for brevity):
\begin{align}
L =&
    \frac{1}{2}
        \Bigg[
            \sum_{j}
            \frac{1}{V_j}
            \sum_{\bm{x}_j}
            \left(z_j[\bm{x}_j]\right)^2
        \Bigg]
    \nonumber\\
&\; -
    \sum_{\lambda}
    \sum_{\bm{\mu}}
    f_{\lambda}(\bm{\mu})
    \left[
        \sum_{j}
        \frac{\tau_{j,\lambda}}{V_j}
        \sum_{\bm{x}_j}
            \; z_j[\bm{x}_j]
            \; \phi_{j,\lambda}\!\left(
                \bm{A}_j(\bm{x}_j) - \bm{\mu}
            \right)
    \right]
    \nonumber\\
&\; +
    \frac{1}{2}
        \sum_{\lambda_1,\lambda_2}
        \sum_{\bm{\mu},\bm{\nu}}
        f_{\lambda_1}(\bm{\mu}) \;
        f_{\lambda_2}(\bm{\nu}) \;
        \Bigg[
        \sum_{j}
            \frac{
                \tau_{j,\lambda_1}
                \tau_{j,\lambda_2}
            }{
                V_j
            }
            \sum_{\bm{x}_j}
            \; \phi_{j,\lambda_1}\!\left(
                \bm{A}_j(\bm{x}_j) - \bm{\mu}
            \right)
            \; \phi_{j,\lambda_2}\!\left(
                \bm{A}_j(\bm{x}_j) - \bm{\nu}
            \right)
        \Bigg]
\end{align}

The three terms in square brackets include all sums over images, and together constitute a sufficient statistic for $f_\lambda$.
Defining them as
\begin{align}
    \kappa \equiv &
        \sum_{j}
            \frac{1}{V_j}
        \sum_{\bm{x}_j}
            \left(z_j[\bm{x}_j]\right)^2
        \equiv \sum_{j} \kappa_j
    \label{eqn:kappa-accumulated}
    \\
    \Psi_{\lambda}[\bm{\mu}] \equiv &
        \sum_{j}
        \frac{\tau_{j,\lambda}}{V_j}
        \sum_{\bm{x}_j}
            \; z_j[\bm{x}_j]
            \; \phi_{j,\lambda}\!\left(
                \bm{A}_j(\bm{x}_j) - \bm{\mu}
            \right)
        \equiv \sum_{j} \Psi_{j,\lambda}[\bm{\mu}]
    \label{eqn:psi-accumulated}
    \\
    \Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}] \equiv &
        \sum_{j}
        \frac{
            \tau_{j,\lambda_1}
            \tau_{j,\lambda_2}
        }{
            V_j
        }
        \sum_{\bm{x}_j}
            \phi_{j,\lambda_1}\!\left(
                \bm{A}(\bm{x}_j) - \bm{\mu}
            \right)
            \; \phi_{j,\lambda_2}\!\left(
                \bm{A}(\bm{x}_j) - \bm{\nu}
            \right)
    \equiv \sum_{j} \Phi_{j,\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    \label{eqn:phi-accumulated}
\end{align}
we can rewrite the likelihood as
\begin{align}
L =&
    \frac{\kappa}{2}
-
    \sum_{\lambda}
    \sum_{\bm{\mu}}
    f_{\lambda}(\bm{\mu})
    \;\Psi_{\lambda}[\bm{\mu}]
+
    \frac{1}{2}
    \sum_{\lambda_1,\lambda_2}
    \sum_{\bm{\mu},\bm{\nu}}
    f_{\lambda_1}(\bm{\mu}) \;
    f_{\lambda_2}(\bm{\nu}) \;
    \Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
\end{align}
Together these already constitutes a coadd of sorts, but this representation is difficult to use and not at all compact; while $\kappa$ is a scalar and $\Psi[\bm{\mu}]$ is one image for each wavelength bin (a total of $W\times|F|$ elements), $\Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]$ has $W^2 \times |F|^2$ elements.
For any realistic number of input epochs and practical cell sizes, that will be more than the total number of input data points.

This indicates that this representation contains significant redundant information, and to find a more compact representation, we follow \citet{2015arXiv151206879Z} and examine the Fourier transform of the per-epoch contributions to $\Phi$.

We will define the 2-d forward Fourier transform and its inverse as
\begin{align}
    \mathcal{F}_{\bm{\mu}}\!\left\{f[\bm{\mu}]\right\}\![\bm{r}]
    \equiv&\;
    \sum_{\bm{\mu}\in{\bm{F}}}
    f[\bm{\mu}]
    \,
    e^{-\frac{2\pi i}{|F|} \bm{\mu}\cdot\bm{r}}
    \\
    \mathcal{F}_{\bm{r}}^{-1}\!\left\{g[\bm{r}]\right\}\![\bm{\mu}]
    \equiv&\;
    \frac{1}{|F|}
    \sum_{\bm{r}\in\bm{F}}
    g[\bm{r}]
    \,
    e^{\frac{2\pi i}{|F|} \bm{r}\cdot\bm{\mu}}
\end{align}
These are discrete transforms in coadd coordinates (the only coordinate system in which we will ever apply Fourier transforms).

We then proceed with the Fourier transform of $\phi_{j,\lambda}$:
\begin{align}
    \mathcal{F}_{\bm{\mu}}\!\left\{
        \phi_{j,\lambda}\!\left(\bm{A}_j(\bm{x}_j) - \bm{\mu}\right)
    \right\}\!\left(\bm{r}\right)
    =&\;
    \mathcal{F}^*_{\bm{\mu}}\!\left\{
        \phi_{j,\lambda}\!\left[\bm{\mu}\right]
    \right\}\!\left(\bm{r}\right)
    \, e^{-\frac{2\pi i}{|F|} \bm{r}\cdot \bm{A}_j(\bm{x}_j)}
\end{align}
\begin{align}
    \mathcal{F}_{\bm{\mu},\bm{\nu}}\!\left\{
        \Phi_{j,\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    \right\}\!\left(\bm{r},\bm{s}\right)
    =&\;
        \frac{
            \tau_{j,\lambda_1}
            \tau_{j,\lambda_2}
        }{
            V_j
        }
        \mathcal{F}^*_{\bm{\mu}}\!\left\{
            \phi_{j,\lambda_1}\!\left[\bm{\mu}\right]
        \right\}\!\left(\bm{r}\right)
        \;
        \mathcal{F}_{\bm{\nu}}\!\left\{
            \phi_{j,\lambda_2}\!\left[\bm{\nu}\right]
        \right\}\!\left(\bm{s}\right)
        \sum_{\bm{x}_j}
        \;
        e^{-\frac{2\pi i}{|F|} (\bm{r} - \bm{s}) \cdot \bm{A}_j(\bm{x}_j)}
    \\
    =&\;
        \delta\!\left(\bm{r}-\bm{s}\right)
        |F^+|
        \frac{
            \tau_{j,\lambda_1}
            \tau_{j,\lambda_2}
        }{
            V_j \; |A_j|
        }
        \;
        \mathcal{F}^*_{\bm{\mu}}\!\left\{
            \phi_{j,\lambda_1}\!\left[\bm{\mu}\right]
        \right\}\!\left(\bm{r}\right)
        \;
        \mathcal{F}_{\bm{\mu}}\!\left\{
            \phi_{j,\lambda_2}\!\left[\bm{\mu}\right]
        \right\}\!\left(\bm{r}\right)
\end{align}
This is \emph{significantly} more compact: we only need to accumulate weighted products of the Fourier transforms of the input image PSFs:
\begin{align}
    \mathcal{F}_{\bm{\mu},\bm{\nu}}\!\left\{
        \Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    \right\}\!\left(\bm{r},\bm{s}\right)
    =&\;
    \delta\!\left(\bm{r}-\bm{s}\right)
    |F^+|
    \sum_j
        \frac{
            \tau_{j,\lambda_1}
            \tau_{j,\lambda_2}\
        }{
            V_j \; |A_j|
        }
        \;
        \mathcal{F}^*_{\bm{\mu}}\!\left\{
            \phi_{j,\lambda_1}\!\left(\bm{\mu}\right)
        \right\}\!\left(\bm{r}\right)
        \;
        \mathcal{F}_{\bm{\mu}}\!\left\{
            \phi_{j,\lambda_2}\!\left(\bm{\mu}\right)
        \right\}\!\left(\bm{r}\right)
    \\
    \widetilde{\Phi}_{\lambda_1,\lambda_2}(\bm{r})
    \equiv &\;
    |F^+|
    \sum_j
        \frac{
            \tau_{j,\lambda_1}
            \tau_{j,\lambda_2}
        }{
            V_j \; |A_j|
        }
        \;
        \mathcal{F}^*_{\bm{\mu}}\!\left\{
            \phi_{j,\lambda_1}\!\left(\bm{\mu}\right)
        \right\}\!\left(\bm{r}\right)
        \;
        \mathcal{F}_{\bm{\mu}}\!\left\{
            \phi_{j,\lambda_2}\!\left(\bm{\mu}\right)
        \right\}\!\left(\bm{r}\right)
\label{eqn:phi-fourier-inputs}
\end{align}

The Fourier transform of $\Phi$ contains all the information of $\Phi$, but we would of course prefer to utilize it without actually having to perform the inverse Fourier transform.
To do that, we should first address the question of what makes a coadd ``easy to use''.
Our definition is that a coadd's likelihood should have a form similar to that of an individual image:
\begin{align}
\bar{L} =&
    \frac{1}{2}
    \sum_{\lambda_1,\lambda_2}
    \bm{C}^{-1}_{\lambda_1,\lambda_2}
    \sum_{\bm{\eta}}
    \bigg(
        \bar{z}_{\lambda_1}[\bm{\eta}]
        - \sum_{\bm{\mu}}\bar{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
        \; f_{\lambda_1}[\bm{\mu}]
    \bigg)
    \;
    \bigg(
        \bar{z}_{\lambda_2}[\bm{\eta}]
        - \sum_{\bm{\nu}}\bar{\phi}_{\lambda_2}[\bm{\eta}-\bm{\nu}]
        \; f_{\lambda_2}[\bm{\nu}]
    \bigg)
    \label{eqn:natural-coadd-likelihood}
\end{align}
with the following definitions:
\begin{itemize}
    \item $z_{\lambda}[\bm{\mu}]$ is the coadd image in wavelength bin $\lambda$.
    \item $\phi_{\lambda}[\bm{\mu}-\bm{\nu}]$ is the effective coadd PSF in wavelength bin $\lambda$.
    \item $\bar{C}_{\lambda_1,\lambda_2}$ is the coadd noise covariance matrix.
\end{itemize}
Note that we are attempting to generate a different coadd image for every wavelength bin; it would clearly be unreasonable to expect these to be uncorrelated.
This definition is thus a generalization of the \emph{proper} coadd concept of \citet{2015arXiv151206879Z} to multiple wavelength bins.

We can expand this in the same manner as the original likelihood to relate the two:
\begin{align}
\bar{L}=&
    \frac{1}{2}
    \Bigg[
        \sum_{\lambda_1,\lambda_2}
        \bar{C}^{-1}_{\lambda_1,\lambda_2}
        \sum_{\bm{\eta}}
        \bar{z}_{\lambda_1}[\bm{\eta}]
        \;\bar{z}_{\lambda_2}[\bm{\eta}]
    \Bigg]
\nonumber\\
&-
    \sum_{\lambda_1}
    \sum_{\bm{\mu}}
        f_{\lambda_1}[\bm{\mu}]
    \Bigg[
        \sum_{\lambda_2}
        \bar{C}^{-1}_{\lambda_1,\lambda_2}
        \sum_{\bm{\eta}}
        \bar{z}_{\lambda_2}[\bm{\eta}]
        \; \bar{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
    \Bigg]
\nonumber\\
&+
    \frac{1}{2}\sum_{\lambda_1,\lambda_2}
        \sum_{\bm{\mu},\bm{\nu}}
        f_{\lambda_1}[\bm{\mu}]
        \; f_{\lambda_2}[\bm{\nu}]
    \Bigg[
        \bar{C}^{-1}_{\lambda_1,\lambda_2}
        \sum_{\bm{\eta}}
        \bar{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
        \; \bar{\phi}_{\lambda_2}[\bm{\eta}-\bm{\nu}]
    \Bigg]
\end{align}
Grouping by factors of $f_{\lambda}(\bm{\mu})$, we can again identify the terms in square brackets in $\bar{L}$ as the same as those we identified in $L$, which means we need to solve
\begin{align}
    \kappa = &
        \sum_{\lambda_1,\lambda_2}
        \bar{C}^{-1}_{\lambda_1,\lambda_2}
        \sum_{\bm{\eta}}
        \bar{z}_{\lambda_1}[\bm{\eta}]
        \; \bar{z}_{\lambda_2}[\bm{\eta}]
    \label{eqn:kappa-factorization}
    \\
    \Psi_{\lambda_1}[\bm{\mu}] = &
        \sum_{\lambda_2}
        \bar{C}_{\lambda_1,\lambda_2}^{-1}
        \sum_{\eta}
        \bar{z}_{\lambda_2}[\bm{\eta}]
        \; \bar{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
    \label{eqn:psi-factorization}
    \\
    \Phi_{\lambda_1,\lambda_2}[\bm{\mu}, \bm{\nu}] = &\;
        \bar{C}^{-1}_{\lambda_1,\lambda_2}
        \sum_{\bm{\eta}}
        \bar{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
        \; \bar{\phi}_{\lambda_2}[\bm{\eta}-\bm{\nu}]
    \label{eqn:phi-factorization}
\end{align}
for $\bar{z}$, $\bar{\phi}$, and $\bar{C}$.
As we will see, Eqn.~\ref{eqn:kappa-factorization} will not actually be needed.

Because we are expecting to accumulate $\Phi$ in Fourier space, we will start our search for a solution by computing the Fourier transform of Eqn.~\ref{eqn:phi-factorization}:
\begin{align}
    \widetilde{\Phi}_{\lambda_1,\lambda_2}[\bm{r}]
    \;
    \delta(\bm{r}-\bm{s})
=&\;
    \mathcal{F}_{\bm{\mu},\bm{\nu}}\!\left\{
        \Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    \right\}\!\left[\bm{r},\bm{s}\right]
\\
=&\;
    \bar{C}^{-1}_{\lambda_1,\lambda_2}
    \sum_{\bm{\eta}}
    \mathcal{F}_{\bm{\mu}}\!\left\{
        \bar{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
    \right\}\!\left[
        \bm{r}
    \right]
    \;
    \mathcal{F}_{\bm{\nu}}\!\left\{
        \bar{\phi}_{\lambda_2}[\bm{\eta}-\bm{\nu}]
    \right\}\!\left[
        \bm{s}
    \right]
\\
=&\;
    \bar{C}^{-1}_{\lambda_1,\lambda_2}
    \;
    \mathcal{F}^*_{\bm{\mu}}\!\left\{
        \bar{\phi}_{\lambda_1}[\bm{\mu}]
    \right\}\!\left[
        \bm{r}
    \right]
    \;
    \mathcal{F}_{\bm{\nu}}\!\left\{
        \bar{\phi}_{\lambda_2}[\bm{\nu}]
    \right\}\!\left[
        \bm{s}
    \right]
    \sum_{\bm{\eta}}
    e^{-\frac{2\pi i}{|F^+|} \bm{\eta}\cdot(\bm{r}-\bm{s})}
\\
=&\;
    |F^+|
    \;
    \bar{C}^{-1}_{\lambda_1,\lambda_2}
    \;
    \mathcal{F}^*_{\bm{\mu}}\!\left\{
        \bar{\phi}_{\lambda_1}[\bm{\mu}]
    \right\}\!\left[
        \bm{r}
    \right]
    \;
    \mathcal{F}_{\bm{\mu}}\!\left\{
        \bar{\phi}_{\lambda_2}[\bm{\mu}]
    \right\}\!\left[
        \bm{r}
    \right]
    \;
    \delta(\bm{r}-\bm{s})
\end{align}
The presence of a delta function on the right-hand side validates our previous assumption that the coadd pixel noise is uncorrelated within wavelength bins.
We can now drop the delta functions from both sides:
\begin{align}
    \widetilde{\Phi}_{\lambda_1,\lambda_2}[\bm{r}]
= & \;
    |F^+|
    \;
    \bar{C}^{-1}_{\lambda_1,\lambda_2}
    \;
    \mathcal{F}^*_{\bm{\mu}}\!\left\{
        \bar{\phi}_{\lambda_1}[\bm{\mu}]
    \right\}\!\left[
        \bm{r}
    \right]
    \;
    \mathcal{F}_{\bm{\mu}}\!\left\{
        \bar{\phi}_{\lambda_2}[\bm{\mu}]
    \right\}\!\left[
        \bm{r}
    \right]
\end{align}
We can use this to obtain $\bar{\phi}$ and $\bar{C}^{-1}$ with the following procedure.
\begin{itemize}
\item For each wavelength bin $\lambda$, compute
    \begin{align}
        p{_\lambda}[\bm{\mu}]
        \mathrel{\mathop:}= &\;
        \mathcal{F}_{\bm{\mu}}^{-1}\!\left\{
            \sqrt{\widetilde{\Phi}_{\lambda,\lambda}[\bm{r}]}
        \right\}\![
            \bm{\mu}
        ]
        \\
        \bar{C}^{-1}_{\lambda,\lambda}
        \mathrel{\mathop:}= &\;
        \left(\sum_{\bm{\mu}} p_{\lambda}[\bm{\mu}]\right)^2
        \\
        \bar{\phi}_{\lambda}[\bm{\mu}]
        \mathrel{\mathop:}= &\;
        \frac{p_{\lambda}[\bm{\mu}]}{\sqrt{\bar{C}_{\lambda,\lambda}}}
        \label{eqn:solution-diagonal-psfs}
    \end{align}
\item For every pair of wavelength bins $\lambda_1 \ne \lambda_2$, compute
    \begin{align}
        \bar{C}^{-1}_{\lambda_1,\lambda_2}
        \mathrel{\mathop:}= &\;
        \frac{
            \widetilde{\Phi}_{\lambda_1,\lambda_2}[\bm{r}]
        }{
            \mathcal{F}_{\bm{\mu}}^{-1}\!\left\{
                \bar{\phi}^*_{\lambda_1}[\bm{\mu}]
            \right\}\![\bm{r}]
            \;
            \mathcal{F}_{\bm{\mu}}^{-1}\!\left\{
                \bar{\phi}_{\lambda_2}[\bm{\mu}]
            \right\}\![\bm{r}]
        }
        \label{eqn:solution-offdiagonal-covariances}
    \end{align}
\end{itemize}

%% TODO: next equations incorrect because \lambda_1 and \lambda_2 are transposed


To obtain $\bar{z}_{\lambda}[\bm{\mu}]$, we examine the Fourier transform of $\Psi_{\lambda}[\bm{\mu}]$:
\begin{align}
    \mathcal{F}_{\bm{\mu}}\!\left\{
        \Psi_{\lambda_1}(\bm{\mu})
    \right\}\!\left[
        \bm{r}
    \right]
    = &
        \sum_{\lambda_2}
        \bar{C}_{\lambda_1,\lambda_2}^{-1}
        \sum_{\eta}
        \bar{z}_{\lambda_1}[\bm{\eta}]
        \;
        \mathcal{F}_{\bm{\mu}}\!\left\{
            \bar{\phi}_{\lambda_2}[\bm{\eta}-\bm{\mu}]
        \right\}\!\left[
            \bm{r}
        \right]
    \\
    = &
        \sum_{\lambda_2}
        \bar{C}_{\lambda_1,\lambda_2}^{-1}
        \;
        \mathcal{F}_{\bm{\mu}}\!\left\{
            \bar{\phi}^*_{\lambda_2}[\bm{\mu}]
        \right\}\!\left[
            \bm{r}
        \right]
        \sum_{\eta}
        \bar{z}_{\lambda_1}[\bm{\eta}]
        \;
        e^{-\frac{2\pi i}{|F^+|} \bm{\eta}\cdot\bm{r}}
    \\
    = & \;
        |F^+|
        \;
        \mathcal{F}_{\bm{\mu}}\!\left\{
            \bar{z}_{\lambda_1}[\bm{\mu}]
        \right\}\!\left[
            \bm{r}
        \right]
        \;
        \sum_{\lambda_2}
        \bar{C}_{\lambda_1,\lambda_2}^{-1}
        \;
        \mathcal{F}_{\bm{\mu}}\!\left\{
            \bar{\phi}^*_{\lambda_2}[\bm{\mu}]
        \right\}\!\left[
            \bm{r}
        \right]
\end{align}
Rearranging, we have:
\begin{align}
    \bar{z}_{\lambda_1}[\bm{\mu}]
    =&\;
    \mathcal{F}^{-1}_{\bm{r}}\!\left\{
        \frac{
            \mathcal{F}_{\bm{\mu}}\!\left\{
                \Psi_{\lambda_1}(\bm{\mu})
            \right\}\!\left[
                \bm{r}
            \right]
        }{
            |F^+|
            \sum\limits_{\lambda_2}
            \bar{C}_{\lambda_1,\lambda_2}^{-1}
            \;
            \mathcal{F}_{\bm{\mu}}\!\left\{
                \bar{\phi}^*_{\lambda_2}[\bm{\mu}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
        \right\}\!\left[
        \bm{\mu}
    \right]
    \label{eqn:solution-image}
\end{align}

Together, Eqns.~\ref{eqn:solution-diagonal-psfs}, \ref{eqn:solution-offdiagonal-covariances}, and \ref{eqn:solution-image} constitute a complete solution to Eqns.~\ref{eqn:psi-factorization} and \ref{eqn:phi-factorization}, and hence a complete prescription for building a coadd that is a sufficient statistic for the input data when:
\begin{itemize}
    \item the PSF is known to arbitrary accuracy;
    \item the noise on all input images is stationary and uncorrelated;
    \item no input images have missing pixels.
\end{itemize}
We will address these limitations in the next sections.

\section{PSF estimation errors}

In the previous section, we assumed we have complete knowledge of the PSF and did not distinguish between the true PSF and the model PSF. While the Fourier-space is computationally simpler, the real-space is conceptually simpler.

The log-likelihood is
\begin{align}
    L =&
        \frac{\kappa}{2}
    -
        \sum_{\lambda}
        \sum_{\bm{\mu}}
        f_{\lambda}(\bm{\mu})
        \;\Psi_{\lambda}[\bm{\mu}]
    +
        \frac{1}{2}
        \sum_{\lambda_1,\lambda_2}
        \sum_{\bm{\mu},\bm{\nu}}
        f_{\lambda_1}(\bm{\mu}) \;
        f_{\lambda_2}(\bm{\nu}) \;
        \Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    \end{align}
    
    The best estimate for the smoothed scene is
    \begin{align}
        f_{\lambda}(\bm{\mu}) = {\Phi_{\lambda_1,\lambda_2}^{-1}[\bm{\mu}, \bm{\nu}]} \Psi_{\lambda}[\bm{\nu}]
    \end{align}

Denoting the estimated PSF as $\hat{\phi}$, 
\begin{align}
    \hat{\Psi}_{\lambda}[\bm{\mu}] \equiv &
        \sum_{j}
        \frac{\tau_{j,\lambda}}{V_j}
        \sum_{\bm{x}_j}
            \; z_j[\bm{x}_j]
            \; \hat{\phi}_{j,\lambda}\!\left(
                \bm{A}_j(\bm{x}_j) - \bm{\mu}
            \right)
        \equiv \sum_{j} \hat{\Psi}_{j,\lambda}[\bm{\mu}]
    \label{eqn:psihat-accumulated}
    \\
    \hat{\Phi}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}] \equiv &
        \sum_{j}
        \frac{
            \tau_{j,\lambda_1}
            \tau_{j,\lambda_2}
        }{
            V_j
        }
        \sum_{\bm{x}_j}
            \hat{\phi}_{j,\lambda_1}\!\left(
                \bm{A}(\bm{x}_j) - \bm{\mu}
            \right)
            \; \hat{\phi}_{j,\lambda_2}\!\left(
                \bm{A}(\bm{x}_j) - \bm{\nu}
            \right)
    \equiv \sum_{j} \hat{\Phi}_{j,\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    \label{eqn:phihat-accumulated}
\end{align}

Taking differential to propagate errors to first order,
\begin{align}
    \delta\bar{z}_{\lambda_1}[\bm{\mu}]
    =&\;
    \mathcal{F}^{-1}_{\bm{r}}\!\left\{
        \frac{
            \mathcal{F}_{\bm{\mu}}\!\left\{
                \delta\Psi_{\lambda_1}(\bm{\mu})
            \right\}\!\left[
                \bm{r}
            \right]
        }{
            |F^+|
            \sum\limits_{\lambda_2}
            \bar{C}_{\lambda_1,\lambda_2}^{-1}
            \;
            \mathcal{F}_{\bm{\mu}}\!\left\{
                \bar{\phi}^*_{\lambda_2}[\bm{\mu}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
        \right\}\!\left[
        \bm{\mu}
    \right] -
    \mathcal{F}^{-1}_{\bm{r}}\!\left\{
        \mathcal{F}_{\bm{\mu}}\left\{\bar{z}_{\lambda_1}[\bm{\mu}]\right\}\left[
            \bm{r}
        \right]
        \frac{
            \delta\sum\limits_{\lambda_2}
            \bar{C}_{\lambda_1,\lambda_2}^{-1}
            \;
            \mathcal{F}_{\bm{\mu}}\!\left\{
                \bar{\phi}^*_{\lambda_2}[\bm{\mu}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
        {
            \sum\limits_{\lambda_2}
            \bar{C}_{\lambda_1,\lambda_2}^{-1}
            \;
            \mathcal{F}_{\bm{\mu}}\!\left\{
                \bar{\phi}^*_{\lambda_2}[\bm{\mu}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
        \right\}\!\left[
        \bm{\mu}
    \right]
    \label{eqn:solution-image-differential}
\end{align}

If the PSF errors at each pixel locations are random about zero, then the coadd pixel values will still be biased due to the second (and even order) terms in $\delta$.

\section{Realistic Noise}

Once the coadd PSFd $\bar{\phi}$ and covarianced $\bar{C}_i$ have been determined, the actual operations performed on the input images are linear.
We could, in theory, write the coaddition process described in the previous section as a matrix product:
\begin{align}
    \bar{z}_{\lambda}[\bm{\mu}]
    =&\;
    \sum_j \sum_{\bm{x}_j}
    T_{\lambda,j}[\bm{\mu},\bm{x}_j]
    \;
    z_j[\bm{x}_j]
\end{align}
Given $\bm{T}$, we could straightforwardly propagate \emph{any} set of true input image noise covariances $\left\{\bm{U}_j\right\}$ to compute the true coadd noise covariance matrix $\bar{U}$:
\begin{align}
    \bar{U}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    =&\;
    \sum_j \sum_{\bm{x}_j,\bm{y}_j}
    T_{\lambda_1,j}[\bm{\mu},\bm{x}_j]
    \,
    T_{\lambda_2,j}[\bm{\nu},\bm{y}_j]
    \,
    U_j[\bm{x}_j,\bm{y}_j]
\end{align}
$\bm{T}$ has $\bm{W} \times |F|$ rows and $\sum\limits_j|E_j|$ columns, making it much too large to compute in full, but it will be useful to have an expression for its elements.
We can derive this by inserting Eqn.~\ref{eqn:psi-accumulated} into Eqn.~\ref{eqn:solution-image}:
\begin{align}
    \bar{z}_{\lambda_1}[\bm{\mu}]
    =&\;
    \mathcal{F}^{-1}_{\bm{r}}\!\left\{
        \frac{
            \mathcal{F}_{\bm{\eta}}\!\left\{
            \sum\limits_{j}
            \frac{\tau_{j,\lambda_1}}{V_j}
            \sum\limits_{\bm{x}_j}
            \phi_{j,\lambda_1}\!\left(
                \bm{A}_j(\bm{x}_j) - \bm{\eta}
            \right)
            \right\}\!\left[
                \bm{r}
            \right]
            \,
            z_j[\bm{x}_j]
        }{
            |F^+|
            \sum\limits_{\lambda_2}
            \bar{C}_{\lambda_1,\lambda_2}^{-1}
            \;
            \mathcal{F}_{\bm{\eta}}\!\left\{
                \bar{\phi}^*_{\lambda_2}[\bm{\eta}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
    \right\}\!\left[
        \bm{\mu}
    \right]
    \,
    \\
    =&\;
    \sum_{j}
    \frac{\tau_{j,\lambda_1}}{V_j}
    \sum_{\bm{x}_j}
    \,
    \mathcal{F}^{-1}_{\bm{r}}\!\left\{
        \frac{
            \mathcal{F}_{\bm{\eta}}\!\!\left\{
            \phi^*_{j,\lambda_1}\!\left[
                \bm{\eta}
            \right]
            \right\}\!\left[
                \bm{r}
            \right]
        }{
            |F^+|
            \sum\limits_{\lambda_2}
            \bar{C}_{\lambda_1,\lambda_2}^{-1}
            \;
            \mathcal{F}_{\bm{\mu}}\!\!\left\{
                \bar{\phi}^*_{\lambda_2}[\bm{\eta}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
        \,
        e^{-2\pi i\,\bm{r}\cdot\bm{A}_j(\bm{x}_j)}
    \right\}\!\left[
        \bm{\mu}
    \right]
    \,
    z_j[\bm{x}_j]
    \\
    T_{\lambda_1,j}[\bm{\mu},\bm{x}_j]
    =&\;
    \frac{\tau_{j,\lambda_1}}{V_j}
    \,
    \mathcal{F}^{-1}_{\bm{r}}\!\left\{
        \frac{
            \mathcal{F}_{\bm{\eta}}\!\left\{
            \phi^*_{j,\lambda_1}\!\left[
                \bm{\eta}
            \right]
            \right\}\!\left[
                \bm{r}
            \right]
        }{
            |F^+|
            \sum\limits_{\lambda_2}
            \bar{C}_{\lambda_1,\lambda_2}^{-1}
            \;
            \mathcal{F}_{\bm{\eta}}\!\left\{
                \bar{\phi}^*_{\lambda_2}[\bm{\eta}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
        \,
        e^{-2\pi i\,\bm{r}\cdot\bm{A}_j(\bm{x}_j)}
    \right\}\!\left[
        \bm{\mu}
    \right]
\end{align}

If the input image covariance matrices are dense, we have no choice but to compute all of the elements of $\bm{T}$ (though we only need keep the elements for one input image in memory at a time).

Typically, however, astronomical images have noise that is uncorrelated or nearly uncorrelated, so we will assume a noise model of the form
\begin{align}
    U_j[\bm{x}_j,\bm{y}_j]
    =&\;
    V_j\,\delta_[\bm{x}_j,\bm{y}_j]
    +
    \!\!\!\!
    \sum_{\bm{p}_j}^{||p_j|| \le R}
    \!\!
    H_j[\bm{x}_j, \bm{p}_j]
    \;
    \delta[\bm{p}_j+\bm{x}_j-\bm{y}_j]
\end{align}
with $R$ typically much less than the size of a cell.

\begin{align}
    \bar{U}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    =&\;
    \sum_j \sum_{\bm{x}_j,\bm{y}_j}
    T_{\lambda_1,j}[\bm{\mu},\bm{x}_j]
    \,
    T_{\lambda_2,j}[\bm{\nu},\bm{y}_j]
    \,
    V_j\,\delta_[\bm{x}_j,\bm{y}_j]
    \\
    &\quad+
    \sum_j \sum_{\bm{x}_j,\bm{y}_j}
    T_{\lambda_1,j}[\bm{\mu},\bm{x}_j]
    \,
    T_{\lambda_2,j}[\bm{\nu},\bm{y}_j]
    \sum_{\bm{p}_j}^{||p_j|| \le R}
    \!\!
    H_j[\bm{x}_j, \bm{p}_j]
    \;
    \delta[\bm{p}_j+\bm{x}_j-\bm{y}_j]
    \\
    =&\;
    \bar{C}_{\lambda_1,\lambda_2}
    \,
    \delta[\bm{\mu}-\bm{\nu}]
    +
    \sum_j \sum_{\bm{x}_j}
    \!\!\!\!
    \sum_{\bm{p}_j}^{||p_j|| \le R}
    \!\!
    T_{\lambda_1,j}[\bm{\mu},\bm{x}_j]
    \;
    T_{\lambda_2,j}[\bm{\nu},\bm{x}_j+\bm{p_j}]
    \;
    H_j[\bm{x}_j, \bm{p}_j]
    \\
    =&\;
    \bar{C}_{\lambda_1,\lambda_2}
    \,
    \delta[\bm{\mu}-\bm{\nu}]
    +
    \bar{H}_{\lambda_1,\lambda_2}[\bm{\mu}, \bm{\nu}]
\end{align}

\begin{align}
    \bar{H}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    =&\;
    \sum_j \sum_{\bm{x}_j}
    \!\!\!\!
    \sum_{\bm{p}_j}^{||p_j|| \le R}
    \!\!
    \left(
        \frac{\tau_{j,\lambda_1}}{V_j}
        \,
        \mathcal{F}^{-1}_{\bm{r}}\!\left\{
            \frac{
                \mathcal{F}_{\bm{\eta}}\!\left\{
                \phi^*_{j,\lambda_1}\!\left[
                    \bm{\eta}
                \right]
                \right\}\!\left[
                    \bm{r}
                \right]
            }{
                |F^+|
                \sum\limits_{\lambda_3}
                \bar{C}_{\lambda_1,\lambda_3}^{-1}
                \;
                \mathcal{F}_{\bm{\eta}}\!\left\{
                    \bar{\phi}^*_{\lambda_3}[\bm{\eta}]
                \right\}\!\left[
                    \bm{r}
                \right]
            }
            \,
            e^{-\frac{2\pi i}{|F^+|}\bm{r}\cdot\bm{A}_j(\bm{x}_j)}
        \right\}\!\left[
            \bm{\mu}
        \right]
    \right)
    \\
    &\qquad\times
    \left(
        \frac{\tau_{j,\lambda_2}}{V_j}
        \,
        \mathcal{F}^{-1}_{\bm{s}}\!\left\{
            \frac{
                \mathcal{F}_{\bm{\zeta}}\!\left\{
                \phi^*_{j,\lambda_2}\!\left[
                    \bm{\zeta}
                \right]
                \right\}\!\left[
                    \bm{s}
                \right]
            }{
                |F^+|
                \sum\limits_{\lambda_4}
                \bar{C}_{\lambda_2,\lambda_4}^{-1}
                \;
                \mathcal{F}_{\bm{\zeta}}\!\left\{
                    \bar{\phi}^*_{\lambda_4}[\bm{\zeta}]
                \right\}\!\left[
                    \bm{s}
                \right]
            }
            \,
            e^{-\frac{2\pi i}{|F^+|}\bm{s}\cdot\bm{A}_j(\bm{x}_j+\bm{p}_j)}
        \right\}\!\left[
            \bm{\nu}
        \right]
    \right)
    \,
    H_j[\bm{x}_j, \bm{p}_j]
\end{align}

\begin{align}
    \bar{H}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    =&\;
    \sum_j
    \frac{\tau_{j,\lambda_1}\tau_{j,\lambda_2}}{V_j^2}
    \sum_{\bm{x}_j}
    \!\!\!\!
    \sum_{\bm{p}_j}^{||p_j|| \le R}
    \!\!
        \mathcal{F}^{-1}_{\bm{r}}\!\left\{
            \frac{
                \mathcal{F}_{\bm{\eta}}\!\left\{
                \phi^*_{j,\lambda_1}\!\left[
                    \bm{\eta}
                \right]
                \right\}\!\left[
                    \bm{r}
                \right]
            }{
                \sum\limits_{\lambda_3}
                \bar{C}_{\lambda_1,\lambda_3}^{-1}
                \;
                \mathcal{F}_{\bm{\eta}}\!\left\{
                    \bar{\phi}^*_{\lambda_3}[\bm{\eta}]
                \right\}\!\left[
                    \bm{r}
                \right]
            }
            \,
            e^{-\frac{2\pi i}{|F^+|}\bm{r}\cdot\bm{A}_j(\bm{x}_j)}
        \right\}\!\left[
            \bm{\mu}
        \right]
    \\
    &\qquad\times
        \,
        \mathcal{F}^{-1}_{\bm{s}}\!\left\{
            \frac{
                \mathcal{F}_{\bm{\zeta}}\!\left\{
                \phi^*_{j,\lambda_2}\!\left[
                    \bm{\zeta}
                \right]
                \right\}\!\left[
                    \bm{s}
                \right]
            }{
                \sum\limits_{\lambda_4}
                \bar{C}_{\lambda_2,\lambda_4}^{-1}
                \;
                \mathcal{F}_{\bm{\zeta}}\!\left\{
                    \bar{\phi}^*_{\lambda_4}[\bm{\zeta}]
                \right\}\!\left[
                    \bm{s}
                \right]
            }
            \,
            e^{-\frac{2\pi i}{|F^+|}\bm{s}\cdot\bm{A}_j(\bm{x}_j+\bm{p}_j)}
        \right\}\!\left[
            \bm{\nu}
        \right]
    \,
    H_j[\bm{x}_j, \bm{p}_j]
\end{align}

\begin{align}
    \bar{H}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
    =&\;
    \sum_j
    \frac{\tau_{j,\lambda_1}\tau_{j,\lambda_2}}{V_j^2|F^+|^2}
    \!\!\!
    \sum_{\bm{p}_j}^{||p_j|| \le R}
    \!\!
    \sum_{\bm{r},\bm{s}}
        \frac{
            \mathcal{F}_{\bm{\eta}}\!\left\{
            \phi^*_{j,\lambda_1}\!\left[
                \bm{\eta}
            \right]
            \right\}\!\left[
                \bm{r}
            \right]
        }{
            \sum\limits_{\lambda_3}
            \bar{C}_{\lambda_1,\lambda_3}^{-1}
            \;
            \mathcal{F}_{\bm{\eta}}\!\left\{
                \bar{\phi}^*_{\lambda_3}[\bm{\eta}]
            \right\}\!\left[
                \bm{r}
            \right]
        }
        \,
        \frac{
            \mathcal{F}_{\bm{\zeta}}\!\left\{
            \phi^*_{j,\lambda_2}\!\left[
                \bm{\zeta}
            \right]
            \right\}\!\left[
                \bm{s}
            \right]
        }{
            \sum\limits_{\lambda_4}
            \bar{C}_{\lambda_2,\lambda_4}^{-1}
            \;
            \mathcal{F}_{\bm{\zeta}}\!\left\{
                \bar{\phi}^*_{\lambda_4}[\bm{\zeta}]
            \right\}\!\left[
                \bm{s}
            \right]
        }
    \\
    &\quad\times
        \sum_{\bm{x}_j}
        e^{
            -\frac{2\pi i}{|F^+|}\bm{r}\cdot[\bm{A}_j(\bm{x}_j)-\bm{\eta}]
            -\frac{2\pi i}{|F^+|}\bm{s}\cdot[\bm{A}_j(\bm{x}_j)+\bm{A}_k(\bm{p}_j)-\bm{\zeta}]
        }
    \,
    H_j[\bm{x}_j, \bm{p}_j]
\end{align}


% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\bibliography{lsst,lsst-dm,refs_ads,refs,books}

\end{document}
