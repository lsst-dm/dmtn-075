\documentclass[DM,authoryear,toc]{lsstdoc}
% lsstdoc documentation: https://lsst-texmf.lsst.io/lsstdoc.html

% Package imports go here.
\usepackage{bm}
\usepackage{color}

% Local commands go here.

\newcommand{\todo}[1]{{\color{red}[#1]}}

% To add a short-form title:
% \title[Short title]{Title}
\title{Cell-Based Coaddition}

% Optional subtitle
% \setDocSubtitle{A subtitle}

\author{%
Jim Bosch
}

\setDocRef{DMTN-075}

\date{\today}

% Optional: name of the document's curator
% \setDocCurator{The Curator of this Document}

\setDocAbstract{%
Design sketch and mathematics for a new approach to building coadds and constraining their inputs.
}

% Change history defined here.
% Order: oldest first.
% Fields: VERSION, DATE, DESCRIPTION, OWNER NAME.
% See LPM-51 for version number policy.
\setDocChangeRecord{%
  \addtohist{1}{YYY-MM-DD}{Unreleased.}{Jim Bosch}
}

\begin{document}

% Create the title page.
% Table of contents is added automatically with the "toc" class option.
\maketitle

\section{Likelihood Coadds}

All quantities are defined within a single cell, which is a rectangle with integer-pixel boundaries in the coadd coordinate systen.
Input-image quantities in cells enclose a larger area: they include any pixel that could contribute to that cell on the coadd.
This means that some input-image pixels contribute to multiple cells.
We assume that cells are sufficiently small that all PSFs, coordinate transforms, and backgrounds can be considered constant over any \emph{two} adjacent cells.

The vast majority of astronomical images have very simple noise properties, at least to good approximation.
Even adjacent pixels are typically very close to uncorrelated, and the only significant spatial variation in the variance is due to photon noise from bright objects.
That spatial variation is explicitly ignored in many astronomical algorithms because including it either produces a negligible improvement in signal-to-noise ratio (because noise from the background dominates), or it increases exposure to systematic errors in regimes where the systematic errors dominate \citep[e.g. PSF photometry of bright stars;][]{2018PASJ...70S...5B}.
Allowing small-scale spatially-varying noise to affect the relative weights of images in a coadd is particularly dangerous, as it can make the effective PSFs on those coadds a function of magnitude, in essence making the coadd's respond to flux nonlinear.

This means that at the very least we should require all input image covariances to be stationary.
We will go one step further, and require the input noise to be a per-cell constant variance \emph{for the purposes of combining images}.
After the linear combination of images has been optimized, we will then propagate the original, fully-general noise covariance matrix to determine the final coadd noise covariance.
This will make our image combination slightly lossy, but only in the rare case where some input images have significantly higher correlations between pixels than others.

Definitions:
\begin{itemize}
\item $\bm{\mu}$, $\bm{\nu}$: vector positions in coadd coordinates (each of $\bm{\mu}$ and $\bm{\nu}$ is a tuple of two coordinates).
\item $\lambda$: an \emph{index} over wavelength bins
\item $\bm{A}_i$: affine mapping from input image $i$ coordinates $\bm{x}_i$to coadd coordinates.
\item $\bm{x}_{i}$, $\bm{y}_i$: positions in the coordinate system of input image $i$ (each of $\bm{x}$ and $\bm{y}$ is a tuple of two coordinates).
\item $z_{i}[\bm{x}_i]$: the value of the pixel at $\bm{x}_i$ in input image $i$, after background subtraction.
\item $\phi_{i,\lambda}(\bm{x}-\bm{y})$: PSF that maps true-sky flux at $\bm{x}$ to observed flux in input image $i$ at $\Delta\bm{y}$, integrated over wavelength bin $\lambda$.  Constrained such that
$\int \phi_{i,\lambda}(\bm{x}) d^2\bm{x} = 1$ for all $\lambda$.
\item $\tau_{i,\lambda}$: Photometric transmission that maps true-sky flux to observed flux in input image $i$, integrated over wavelength bin $\lambda$
\item $V_{i}$: noise variance on input image $i$, assumed constant over the cell.
\item $N$: the number of input images.
\item $W$: the number of wavelength bins.
\item $\bm{E}_i$: the set of all pixel indices in input image $i$ that contribute to the current cell.  $|E_i|$ is used to denote the total number of pixels from that image that contribute to the cell.  Bad pixels can simply be omitted from this set with no loss of generality.
\item $\bm{F}$: the set of all coadd pixel indices in the cell.  $|F|$ is used to denote the total number of pixels in the cell.
\item $\alpha_{\lambda}(\bm{\mu})$: true above-the-atmosphere scene in coadd coordinates, integrated over wavelength bin $\lambda$, not including backgrounds.
\end{itemize}

The approach described here is a generalization of the method described by \citet{2015arXiv151206879Z}, and yields identical results when all input images are well-sampled, there are no missing pixels, and image PSFs are achromatic.  In that limit the input images can be perfectly resampled to a common grid in advance, which is the point at which their algorithm begins.

Instead, we start from the joint log-likelihood of the true scene given all input images in their original coordinate systems, allowing us to handle both undersampled data and missing pixels.
That log-likelihood is:
\begin{align}
L \equiv &
    \frac{1}{2} \sum_{i=0}^{i<N}
        \frac{1}{V_i}
        \sum_{\bm{x}_i \in \bm{E}_i}
        \left(
            z_i[\bm{x}_i]
            - \sum_{\lambda=0}^{\lambda < W}
                \frac{\tau_{i,\lambda}}{|A_i|}
                \int\!
                \phi_{i,\lambda}\!\left(
                    \bm{x}_i - \bm{A}_i^{-1}(\bm{\nu})
                \right)
                \; \alpha_{\lambda}(\bm{\nu})
                \; d^2\bm{\nu}
        \right)^2
\end{align}

While the true sky contains power at arbitrarily small spatial scales, the PSFs do not; we can always choose the coadd coordinate system such that all
input PSFs are well-sampled on that grid.
We can thus exactly represent the continuous PSF as a sinc interpolation of
discrete samples from it:
\begin{align}
    \phi_{i,\lambda}(\bm{x}_i-A_i^{-1}\bm{\nu}) =
    \sum_{\bm{\mu} \in \bm{F}}
        \mathrm{sinc}\big(\pi(\bm{\nu}-\bm{\mu})\big)
        \;\phi_{i,\lambda}\!\left(
            \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
        \right)
\end{align}
We can then insert this into the convolution integral,
\begin{align}
    \int\!
        \, \phi_{i,\lambda}\!\left(\bm{x}_i-\bm{A}_i^{-1}(\bm{\mu})\right)
        \, \alpha_{\lambda}(\bm{\mu})
        \, d^2\bm{\mu}
    = &
    \sum_{\bm{\mu} \in \bm{F}}
        \;\phi_{i,\lambda}\!\left(
            \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
        \right)
        \!\int\!
        \mathrm{sinc}\big(\pi(\bm{\nu}-\bm{\mu})\big)
        \; \alpha_{\lambda}(\bm{\nu})
        \; d^2\bm{\nu} \\
    = &
    \sum_{\bm{\mu} \in \bm{F}}
        \;\phi_{i,\lambda}\!\left(
            \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
        \right)
        \, f_{\lambda}(\bm{\mu})
\end{align}
with the sinc-convolved true scene $f_{\lambda}$ defined as
\begin{align}
    f_{\lambda}(\bm{\mu}) \equiv \int\!
        \mathrm{sinc}\big(\pi(\bm{\nu}-\bm{\mu})\big)
        \; \alpha_{\lambda}(\bm{\nu})
        \; d^2\bm{\nu}
\end{align}
Thus, $f_{\lambda}$ is essentially a band-limited version of $\alpha_{\lambda}$, restricted to just the spatial frequencies we can constrain from the input data (via our requirement that the coadd coordinate grid fully sample all input PSFs).
We therefore consider any sufficient statistic for $f_{\lambda}$ to also be a sufficient statistic for $\alpha_{\lambda}$.

We can now substitute this into the joint likelihood:
\begin{align}
L = &
    \frac{1}{2} \sum_{i=0}^{i<N}
        \frac{1}{V_i}
        \sum_{\bm{x}_i \in \bm{E}_i}
        \left(
            z_i[\bm{x}_i]
            - \sum_{\lambda=0}^{\lambda < W}
                \frac{\tau_{i,\lambda}}{|A_i|}
                \sum_{\bm{\mu} \in \bm{F}}
                        \;\phi_{i,\lambda}\!\left(
                            \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
                        \right)
                        \, f_{\lambda}(\bm{\mu})
        \right)^2
\end{align}
expand the terms:
\begin{align}
L =&
        \sum_{i=0}^{i<N}
        \frac{1}{2V_i}
        \sum_{\bm{x}_i \in \bm{E}_i}
        \left(z_i[\bm{x}_i]\right)^2
\nonumber\\
&\;-
    \sum_{i=0}^{i<N}
        \frac{1}{V_i}
        \sum_{\bm{x}_i \in \bm{E}_i}
        \; z_i[\bm{x}_i]
        \sum_{\lambda=0}^{\lambda < W}
            \frac{\tau_{i,\lambda}}{|A_i|}
            \sum_{\bm{\mu} \in \bm{F}}
                    \;\phi_{i,\lambda}\!\left(
                        \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
                    \right)
                    \, f_{\lambda}(\bm{\mu})
\nonumber\\
&\;+
    \sum_{i=0}^{i<N}
        \frac{1}{2V_i}
        \sum_{\bm{x}_i \in \bm{E}_i}
        \left(
            \sum_{\lambda=0}^{\lambda < W}
                \frac{\tau_{i,\lambda}}{|A_i|}
                \sum_{\bm{\mu} \in \bm{F}}
                        \;\phi_{i,\lambda}\!\left(
                            \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
                        \right)
                        \, f_{\lambda}(\bm{\mu})
        \right)^2
\end{align}
and reorder the sums (consolidating some for brevity):
\begin{align}
L =&
    \frac{1}{2}
        \Bigg[
            \sum_{i}
            \frac{1}{V_i}
            \sum_{\bm{x}_i}
            \left(z_i[\bm{x}_i]\right)^2
        \Bigg]
    \nonumber\\
&\; -
    \sum_{\lambda}
    \sum_{\bm{\mu}}
    f_{\lambda}(\bm{\mu})
    \left[
        \sum_{i}
        \frac{\tau_{i,\lambda}}{V_i|A_i|}
        \sum_{\bm{x}_i}
            \; z_i[\bm{x}_i]
            \; \phi_{i,\lambda}\!\left(
                \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
            \right)
    \right]
    \nonumber\\
&\; +
    \frac{1}{2}
        \sum_{\lambda_1,\lambda_2}
        \sum_{\bm{\mu},\bm{\nu}}
        f_{\lambda_1}(\bm{\mu}) \;
        f_{\lambda_2}(\bm{\nu}) \;
        \Bigg[
        \sum_{i}
            \frac{
                \tau_{i,\lambda_1}
                \tau_{i,\lambda_2}
            }{
                V_i |A_i|^2
            }
            \sum_{\bm{x}_i}
            \; \phi_{i,\lambda_1}\!\left(
                    \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
            \right)
            \; \phi_{i,\lambda_2}\!\left(
                \bm{x}_i - \bm{A}_i^{-1}(\bm{\nu})
            \right)
        \Bigg]
\end{align}

The three terms in square brackets include all sums over images, and together constitute a sufficient statistic for $f_\lambda$.
Defining them as
\begin{align}
    \kappa \equiv &
        \sum_{i}
            \frac{1}{V_i}
        \sum_{\bm{x}_i}
            \left(z_i[\bm{x}_i]\right)^2
        \equiv \sum_{i} \kappa_i
    \\
    \Psi_{\lambda}[\bm{\mu}] \equiv &
        \sum_{i}
        \frac{\tau_{i,\lambda}}{V_i |A_i|}
        \sum_{\bm{x}_i}
            \; z_i[\bm{x}_i]
            \; \phi_{i,\lambda}\!\left(
                \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
            \right)
        \equiv \sum_{i} \Psi_{i,\lambda}[\bm{\mu}]
    \\
    \Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}] \equiv &
        \sum_{i}
            \frac{
                \tau_{i,\lambda_1}
                \tau_{i,\lambda_2}
            }{
                V_i |A_i|^2
            }
        \sum_{\bm{x}_i}
            \phi_{i,\lambda_1}\!\left(
                    \bm{x}_i - \bm{A}_i^{-1}(\bm{\mu})
            \right)
            \; \phi_{i,\lambda_2}\!\left(
                \bm{x}_i - \bm{A}_i^{-1}(\bm{\nu})
            \right)
    \equiv \sum_{i} \Phi_{i,\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
\end{align}
we can rewrite the likelihood as
\begin{align}
L =&
    \frac{\kappa}{2}
-
    \sum_{\lambda}
    \sum_{\bm{\mu}}
    f_{\lambda}(\bm{\mu})
    \;\Psi_{\lambda}[\bm{\mu}]
+
    \frac{1}{2}
    \sum_{\lambda_1,\lambda_2}
    \sum_{\bm{\mu},\bm{\nu}}
    f_{\lambda_1}(\bm{\mu}) \;
    f_{\lambda_2}(\bm{\nu}) \;
    \Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]
\end{align}
Together these already constitutes a coadd of sorts, but this representation is difficult to use and not at all compact; while $\kappa$ is a scalar and $\Psi[\bm{\mu}]$ is one image for each wavelength bin (a total of $W\times|F|$ elements), $\Phi_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]$ has $W^2 \times |F|^2$ elements.
For any realistic number of input epochs and practical cell sizes, that will be more than the total number of input data points.

This indicates that this representation contains significant redundant information, but before tackling the problem of how to compress it we will first address the question of what makes a coadd ``easy to use''.
Our definition is that such a coadd's likelihood should have a form similar to that of an individual image:
\begin{align}
\hat{L} =&
    \frac{1}{2}\sum_{\bm{\eta},\bm{\zeta}}
    \bigg(
        \hat{z}_{\lambda_1}[\bm{\eta}]
        - \sum_{\bm{\mu}}\hat{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
        \; f_{\lambda_1}[\bm{\mu}]
    \bigg)
    \; \hat{C}^{-1}_{\lambda_1,\lambda_2}[\bm{\eta},\bm{\zeta}]
    \; \bigg(
        \hat{z}_{\lambda_2}[\bm{\zeta}]
        - \sum_{\bm{\nu}}\hat{\phi}_{\lambda_2}[\bm{\zeta}-\bm{\nu}]
        \; f_{\lambda_2}[\bm{\nu}]
    \bigg)
    \label{eqn:natural-coadd-likelihood}
\end{align}
with the following definitions:
\begin{itemize}
    \item $z_{\lambda}[\bm{\mu}]$ is the coadd image in wavelength bin $\lambda$.
    \item $\phi_{\lambda}[\bm{\mu}-\bm{\nu}]$ is the effective coadd PSF in wavelength bin $\lambda$.
    \item $\hat{C}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]$ is the coadd noise covariance matrix, and the only term that relates different wavelength bins.
\end{itemize}
Note that we do not expect the coadd noise to be stationary or uncorrelated, and we are attempting to generate a different image for every wavelength bin.

We can expand this in the same manner as the original likelihood to relate the two:
\begin{align}
\hat{L}=&
    \frac{1}{2}\sum_{\lambda_1,\lambda_2}
    \Bigg[
        \sum_{\bm{\eta},\bm{\zeta}}
        \hat{z}_{\lambda_1}[\bm{\eta}]
        \;\hat{C}^{-1}_{\lambda_1,\lambda_2}[\bm{\eta},\bm{\zeta}]
        \;\hat{z}_{\lambda_2}[\bm{\zeta}]
    \Bigg]
\nonumber\\
&-
    \sum_{\lambda}
    \sum_{\bm{\mu}}
        f_{\lambda}[\bm{\mu}]
    \Bigg[
        \sum_{\lambda_1}
        \sum_{\bm{\eta},\bm{\zeta}}
        \hat{z}_{\lambda_1}[\bm{\eta}]
        \; \hat{C}^{-1}_{\lambda_1,\lambda}[\bm{\eta},\bm{\zeta}]
        \; \hat{\phi}_{\lambda}[\bm{\zeta}-\bm{\mu}]
    \Bigg]
\nonumber\\
&+
    \frac{1}{2}\sum_{\lambda_1,\lambda_2}
        \sum_{\bm{\mu},\bm{\nu}}
        f_{\lambda_1}[\bm{\mu}]
        \; f_{\lambda_2}[\bm{\nu}]
    \Bigg[
        \sum_{\bm{\eta},\bm{\zeta}}
        \hat{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
        \; \hat{C}^{-1}_{\lambda_1,\lambda_2}[\bm{\eta},\bm{\zeta}]
        \; \hat{\phi}_{\lambda_2}[\bm{\zeta}-\bm{\nu}]
    \Bigg]
\end{align}
Grouping by factors of $f_{\lambda}(\bm{\mu})$, we can again identify the terms in square brackets in $\hat{L}$ as the same as those we identified in $L$, which means we need to solve
\begin{align}
    \kappa = &
        \sum_{\bm{\eta},\bm{\zeta}}
        \hat{z}_{\lambda_1}[\bm{\eta}]
        \; \hat{C}^{-1}_{\lambda_1,\lambda_2}[\bm{\eta},\bm{\zeta}]
        \; \hat{z}_{\lambda_2}[\bm{\zeta}]
    \label{eqn:kappa-factorization}
    \\
    \Psi_{\lambda_1}[\bm{\nu}] = &
        \sum_{\eta,\nu}
        \hat{z}_{\lambda_1}[\bm{\eta}]
        \; \hat{C}_{\lambda_1,\lambda_2}^{-1}\![\bm{\eta},\bm{\zeta}]
        \; \hat{\phi}_{\lambda_2}\![\bm{\zeta}-\bm{\nu}]
    \label{eqn:psi-factorization}
    \\
    \Phi_{\lambda_1,\lambda_2}[\bm{\mu}, \bm{\nu}] = &
        \sum_{\bm{\eta},\bm{\zeta}}
        \hat{\phi}_{\lambda_1}[\bm{\eta}-\bm{\mu}]
        \; \hat{C}^{-1}_{\lambda_1,\lambda_2}[\bm{\eta},\bm{\zeta}]
        \; \hat{\phi}_{\lambda_2}[\bm{\zeta}-\bm{\nu}]
    \label{eqn:phi-factorization}
\end{align}
for $\hat{z}$, $\hat{\phi}$, and $\hat{C}$.
Any solution is a sufficient statistic for $f_{\lambda}$ and thus an optimal coadd, but solutions that minimize the number of nonzero off-diagonal elements of $\hat{C}_{\lambda_1,\lambda_2}[\bm{\mu},\bm{\nu}]$ are easier to use, easier to interpret, and more compact.


% Include all the relevant bib files.
% https://lsst-texmf.lsst.io/lsstdoc.html#bibliographies
\bibliography{lsst,lsst-dm,refs_ads,refs,books}

\end{document}
